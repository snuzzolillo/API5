<!DOCTYPE HTML>
<html>
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="language" content="en">
    <title>DO_SQL Example</title>

    <!-- JQUERY -->
    <script src="../scripts/jquery-1.11.1.min.js" type="text/javascript"></script>
    <script src="../scripts/jquery._ui_1.11.4.min.js" type="text/javascript"></script>
    <!--  -->


    <!-- Requerido para encriptar el password >
    <script src="./js/cryptojs-aes/aes.js" type="text/javascript"></script>
    <script src="./js/cryptojs-aes/aes-json-format.js" type="text/javascript"></script>
    <!--  -->

    <!-- VIEW TREE DATA -->

    <!-- dynatree -->
    <!-- Requerido para la declaracion de clases -->
    <script src="/portada/lib/src/class.js" type="text/javascript"></script>
    <!--  -->
    <!-- treeManeger inclye el menu cotextual -->
    <script src="/portada/lib/src/jquery.dynatree.js" type="text/javascript"></script>
    <!--script src="/portada//lib/src/jquery.fancytree.js" type="text/javascript"></script-->
    <link href="/portada//lib/src/skin/ui.dynatree.css" rel="stylesheet" type="text/css">
    <!--link href="../lib/src/skin-vista/ui.fancytree.css" rel="stylesheet" type="text/css"-->
    <script src="/portada/lib/js/treeManagerV3.1.js" type="text/javascript"></script>
    <!--script src="../lib/js/treeManagerV2.js" type="text/javascript"></script-->
    <!-- end dynatree -->


    <!--  -->

<script>
    /*
    GET JWT TOKEN AND SAVE INTO LOCALSTORAGE
    NOT SES ENCRTPTED
     */
    var token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJET1NRTCIsInN1YiI6ImFwaTUiLCJhdWQiOiJkZXZlbG9wZXIiLCJpYXQiOjE1MTYyMDg2MTAsImV4cCI6MTUxNjgxMzQxMCwibmJmIjoxMzU3MDAwMDAwLCJ1aWQiOiJkZXZlbG9wZXIiLCJkYXRhIjoie1widXNlcm5hbWVcIjpcImFub255bW91c1wiLCBcInVzZXJyb2xlc1wiOlsxLDJdfSJ9.KKnnRDTnekOfZCcA5dcuNYIJkiB9Nv-jcNLA5LRkTyc';
    // VENCIDO var token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJET1NRTCIsInN1YiI6ImFwaTUiLCJhdWQiOiJkZXZlbG9wZXIiLCJpYXQiOjE1MTQ5MDU0MjEsImV4cCI6MTUxNDkwNTQyOCwibmJmIjoxMzU3MDAwMDAwLCJ1aWQiOiJkZXZlbG9wZXIiLCJkYXRhIjoie1widXNlcm5hbWVcIjpcImFub255bW91c1wiLCBcInVzZXJyb2xzXCI6XCJbXVwifSJ9.5yI9DsVCm5tW0TnfVjmw7obR40tv5gS4ZNgaYWVhe0Q';
    //A FUTURO var token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJET1NRTCIsInN1YiI6ImFwaTUiLCJhdWQiOiJkZXZlbG9wZXIiLCJpYXQiOjE1MTQ5MDU2NjIsImV4cCI6MTUxNTUxMDQ2MiwibmJmIjoxNTE1NTEwNDYyLCJ1aWQiOiJkZXZlbG9wZXIiLCJkYXRhIjoie1widXNlcm5hbWVcIjpcImFub255bW91c1wiLCBcInVzZXJyb2xzXCI6XCJbXVwifSJ9.8Bc4VdbzDcC1oLCbj3KmxZ3C8AjETuTt0Tb0y6vWnLc';
    localStorage.setItem('token', token);
</script>

<script>
	$(document).ready(function() {

		/*
		console.log("Start script principal");
		getDO_SQL();

		//var script1 = "\<script type='text/javascript' src='../js/do_sql.js'\> \<\/script\>";
		var script1 = "\<script id='script1' type='text/javascript'> \<\/script\>";
		var script2 = ""
		*/

        /*
         * PRUEBA DE LECTURA Y EJECUCION
         *
        */
        var bind = {
            //valor1 : '10-2-2-2'
            //, valor2 : 1
            //, valor3 : 1.25
            //, valor4 : 'texto'
            //, valor5 : '1600-12-31'
             username : 'system'
        }
        /*
		jQuery.ajax({
			url: './services/api5.php'
            , type : 'POST'
            , data : {
                    //, SQL : 'select * from mysql.user where user = :username'
                    SQL : 'select :username username from dual'
                    , BIND : JSON.stringify(bind)
                    , transactiontype : 'QUERY'
                    //,'token':localStorage.getItem('token')
                }
            ,dataType: "json"
            ,headers: {"Authorization": "token="+localStorage.getItem('token')}
			,success: function (result) {
				if (result.isOk == false) {
					script2 = result.message;
					alert('Error Loading JS');
				} else {
					script2 = result;
				}
			}
            , error : function(a,b,c,d) {

                console.log('ERROR :', this.url, 'STATUS:',a.status);
                console.log('ERROR :', b, c,d);
            }
			,async: true
		});
        */
        // TEST TREE o DATOS JERARQUICOS
        // api5 requiere de un token valido;
        $.ajaxSetup({
                headers: {"Authorization": "token="+localStorage.getItem('token')}
        });
        var test = 5;
        var treeTest = "";
        if (test === 1) {
            var testTree = function (cod_estructura) {
                // SIMPLE TREE
                // TEST TREE DEBE RECIBIR UN JSON PARA CONSTRUIR EL ARBOL
                // API5 requiere indicar
                // 1) el data source
                // 2) el SQL o definicion de como construir el arbol
                // 3) indicar que se quiere el resultado tipo Jerarquia: HRCHY
                // es requerido que el SQL debe ir a traves del post

                if (treeTest != "") {
                    //$("#testTree").dynatree("option", "initAjax", {url: "../services/estructuras_nodos_niveles.php?getdatanode=y&cod_estructura="+cod_estructura+"&cod_tipo_start=&cod_filtro_start=&show_first_node=y"});
                    //$("#testTree").dynatree("getTree").reload();
                    treeTest.setRootID(cod_estructura);
                    treeTest.setUrl("./services/api5.php");
                    treeTest.reload();
                } else {
                    // treeManager_CLASS tiene la option de parametersPost
                    var data = {
                        BIND: JSON.stringify({estructura: cod_estructura})
                        , SQL: ':uic.simpletree2'
                        , sourcename: 'default' // si no se indica nada es default
                        , transactiontype: 'HRCHY'
                        , jsonstyle: 'SIMPLE'
                    }
                    treeTest = new treeManager_CLASS({
                        urlToFill: "./services/api5.php"
                        //,urlToSync      : ""
                        , rootID: cod_estructura
                        , elementID: 'testTree'
                        , allowEditTree: false
                        //,parametersPost : data
                        , postProcess: function (data, b) {
                            console.log('POST PROCESSING ', data, b);
                            if (typeof data.ERROR !== "undefined") {
                                if (data.ERROR.CODE != 0) {
                                    console.log(data.ERROR);
                                    alert(data.ERROR.CODE + ' ' + data.ERROR.MESSAGE);
                                    return [{}];
                                }
                                return data.DATA;
                            } else {
                                console.log("postProcess data=", data)
                                return data;
                            }
                        }
                    });
                    // data es pasado por jquery ajax post parameters
                    treeTest.createTree(data);
                }
            }
            testTree('_38');
        }

        if (test === 2) {
            var testTree = function (cod_estructura) {
                // BY NODE TREE
                // TEST TREE DEBE RECIBIR UN JSON PARA CONSTRUIR EL ARBOL
                // API5 requiere indicar
                // 1) el data source
                // 2) el SQL o definicion de como construir el arbol
                // 3) indicar que se quiere el resultado tipo Jerarquia: HRCHY
                // es requerido que el SQL debe ir a traves del post

                if (treeTest != "") {
                    //$("#testTree").dynatree("option", "initAjax", {url: "../services/estructuras_nodos_niveles.php?getdatanode=y&cod_estructura="+cod_estructura+"&cod_tipo_start=&cod_filtro_start=&show_first_node=y"});
                    //$("#testTree").dynatree("getTree").reload();
                    treeTest.setRootID(cod_estructura);
                    treeTest.setUrl("./services/api5.php");
                    treeTest.reload();
                } else {
                    // treeManager_CLASS tiene la option de parametersPost
                    var data = {
                        BIND: JSON.stringify({estructura: cod_estructura})
                        , SQL: ':uic.generic'
                        , sourcename: 'default' // si no se indica nada es default
                        , transactiontype: 'HRCHY'
                        , jsonstyle: 'BY NODE'
                    }
                    treeTest = new treeManager_CLASS({
                        urlToFill       : "./services/api5.php"
                        //,urlToSync      : ""
                        , rootID        : cod_estructura
                        , elementID     : 'testTree'
                        , allowEditTree : false
                        //,parametersPost : data
                        , postProcess: function (data, b) {
                            console.log('POST PROCESSING ', data, b);
                            if (typeof data.ERROR !== "undefined") {
                                if (data.ERROR.CODE != 0) {
                                    console.log(data.ERROR);
                                    alert(data.ERROR.CODE + ' ' + data.ERROR.MESSAGE);
                                    return [{}];
                                }
                                return data.DATA;
                            } else {
                                console.log("postProcess data=", data)
                                return data;
                            }
                        }
                    });
                    // data es pasado por jquery ajax post parameters
                    treeTest.createTree(data);
                }
            }
            testTree('_399');
        }

        if (test === 3) {

            // MASTER-DETAL
            // TEST JERARUIAS TIPO MASTER-DETAIL
            // API5 requiere indicar
            // 1) el data source
            // 2) el JSON o definicion de como construir el MASTER-DETAIL via parametro SQL
            // 3) indicar que se quiere el resultado tipo Jerarquia: HRCHY
            // es requerido que el SQL debe ir a traves del post
            var masterDetalDef = {"Name": "ZONAS"
                ,"RelationType": "0"
                ,"Query" : "SELECT id, cod_afiliacion, cod_actividad, zona, cod_centro" +
                " FROM ele_centro_zonas" +
                " where cod_actividad = 1" +
                ""
                ,"DeleteRecord": "1"
                ,"Detail": [{
                    "Name": "CENTROS"
                    ,"RelationType": "0"
                    ,"Query" : "SELECT id, cod_pais, cod_estado, cod_municipio, cod_parroquia, cod_centro, nom_centro, dir_centro, cod_unico, status, fecha, latitud, longitud" +
                    " FROM geo_centros" +
                    " where cod_centro like :cod_centro" +
                    ""
                    ,"DeleteRecord": "1"
                    ,"Detail": []
                    ,"AutoQuery": "true"
                    ,"JoinCondition": "CENTROS.cod_centro = zonas.cod_centro"
                }]
                ,"AutoQuery": "true"
            };
            var bind = {Cod_Centro:'709%'}; // No hay parametros
            jQuery.ajax({
                url: './services/api5.php'
                , type : 'post'
                , data : {
                    //SQL : ':uic.master_detail' // Contiene la definicion necesaria para generar el maestro detalle
                    SQL : JSON.stringify(masterDetalDef) // Contiene la definicion necesaria para generar el maestro detalle
                    , BIND : JSON.stringify(bind)
                    , transactiontype: 'HRCHY'
                    , jsonstyle: 'MASTER-DETAILS'
                }
                ,dataType: "json"
                ,headers: {"Authorization": "token="+localStorage.getItem('token')}
                ,success: function (result) {
                    if (result.isOk == false) {
                        script2 = result.message;
                        alert('Error Loading JS');
                    } else {
                        script2 = result;
                    }
                }
                , error : function(a,b,c,d) {

                    console.log('ERROR :', this.url, 'STATUS:',a.status);
                    console.log('ERROR :', b, c,d);
                }
                ,async: true
            });
        }

        if (test === 4) {

            /*
            // TEST WITHOUT JQUERY
            var data = new FormData();
            //var bind = {username:"a%"}
            data.append('SQL', 'select * from departments2'); // where username like :username');
            //data.append('BIND', JSON.stringify(bind));
            //data.append('jsonstyle', 'ARRAY');
            //data.append('lote', '10');

            var xhr = new XMLHttpRequest();
            xhr.open('POST', './services/api5.php', true);
            xhr.onreadystatechange  = function (obj) {

                    switch (xhr.readyState) {
                        case 0: // UNINITIALIZED
                        case 1: // LOADING
                        case 2: // LOADED
                        case 3: // INTERACTIVE
                            break;
                        case 4: // COMPLETED
                            console.log("Compleated", this.status);
                                switch (Math.floor(this.status/100)) {
                                    case 1:
                                    case 2:
                                    case 3:
                                        console.log("Success", this.status);
                                        break;
                                    default :
                                            var errorDetail = "";
                                            try {
                                                var errorDetail = JSON.parse(this.responseText);
                                            } catch (e) {
                                                errorDetail = {ERROR : {MESSAGE : this.responseText, CODE: 'undefined'}};
                                            }
                                        console.log("Error", this.status, 'INTERNAL CODE' , errorDetail.ERROR.CODE, 'MESSAGE', errorDetail.ERROR.MESSAGE);
                                }
                            break;
                        default:
                            console.log('ERROR');
                            //alert("error");
                    }
                // do something to response
            }
            xhr.onerror = function () {
                // do something to response
               //alert('ERROR');
                console.log('Error', this);
            }            //xhr.setRequestHeader("Authorization", "token="+localStorage.getItem('token'));
            xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest"); // Required to detect that is a XHR
            xhr.send(data);

            // QUERY
            // TEST ANY QUERY
            // API5 requiere indicar
            // 1) el data source
            // 2) el SQL
            // 3) indicar que se quiere el resultado tipo transaccion: QUERY
            // es requerido que el SQL vaya a traves del post
            //var bind = {Cod_Centro:'70901001'}; // No hay parametros
            // TEST WITH JQUERY
            jQuery.ajax({
                url: './services/api5.php'
                , type : 'post'
                , data : {
                    SQL : 'select * from departments'
                    //, BIND : JSON.stringify(bind)
                    //, transactiontype: 'QUERY'
                    //, jsonstyle: 'OBJECT' // OBJECT o ARRAY
                }
                //,dataType: "json"
                //,headers: {"Authorization": "token="+localStorage.getItem('token')}
                ,success: function (result) {
                    // DO stuff
                    console.log(result.DATA);
                    console.log(result.HEADER);
                    console.log(result.INFO);
                }
                , error : function(xhr) {
                    var errorDetail = xhr.responseJSON;
                    console.log("Error", xhr.status, 'INTERNAL CODE' , errorDetail.ERROR.CODE, 'MESSAGE', errorDetail.ERROR.MESSAGE);
                    //console.log('a=',a,'b=',b,'c=', c,'d=',d);
                }
            });

            */
            // ---------------------------------------------------
            // NOTE: When you use the API and get any error about your request
            // you will get an http_response = 400.
            // Errors include script (PHP) error and
            // sql statement execution or syntax error
            // ---------------------------------------------------

            // ---------------------------------------------------
            // TEST PLAIN JAVASCRIPT
            var data = new FormData();
            data.append('SQL', 'select * from departments2');

            var xhr = new XMLHttpRequest();
            xhr.open('POST', './services/api5.php', true);
            xhr.onreadystatechange  = function (obj) {
                switch (xhr.readyState) {
                    case 0: // UNINITIALIZED
                    case 1: // LOADING
                    case 2: // LOADED
                    case 3: // INTERACTIVE
                        break;
                    case 4: // COMPLETED
                        console.log("Compleated", this.status);
                        switch (Math.floor(this.status/100)) {
                            case 1:
                            case 2:
                            case 3:
                                // do something to response
                                console.log("Success", this.status);
                                break;
                            default :
                                // errors 4xx or 5xx if Object ERROR.CODE on response is diferent to "0" API5 will return 400 http_response
                                var errorDetail = "";
                                try {
                                    var errorDetail = JSON.parse(this.responseText);
                                } catch (e) {
                                    errorDetail = {ERROR : {MESSAGE : this.responseText, CODE: 'undefined'}};
                                }
                                console.log("Error", this.status, 'INTERNAL CODE' , errorDetail.ERROR.CODE, 'MESSAGE', errorDetail.ERROR.MESSAGE);
                        }
                        break;
                    default:
                        console.log('OTHERS POSSIBLES ERROR');
                }
            }
            xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest"); // Required to detect that is a XHR
            xhr.send(data);
            // ---------------------------------------------------

            // ---------------------------------------------------
            // TEST WITH JQUERY
            jQuery.ajax({
                url: './services/api5.php'
                , type : 'post'
                , data : {
                    SQL : 'select * from departments'
                }
                ,success: function (result) {
                    // DO stuff
                    console.log(result.DATA);
                    console.log(result.HEADER);
                    console.log(result.INFO);
                }
                , error : function(xhr) {
                    var errorDetail = xhr.responseJSON;
                    console.log("Error", xhr.status, 'INTERNAL CODE' , errorDetail.ERROR.CODE, 'MESSAGE', errorDetail.ERROR.MESSAGE);
                    //console.log('a=',a,'b=',b,'c=', c,'d=',d);
                }
            });
            // ---------------------------------------------------

        }

        if (test == 5) {
            // TEST DML WITH JQUERY
            jQuery.ajax({
                url: './services/api5.php'
                , type : 'post'
                , data : {
                    //SQL : 'select * from departments'
                    SQL : "select dept_name, :zona.id into :Dept_name_12345678901234567890123456789012345 from departments where dept_no = :dept_no and :Nombre is null and :system.nada = 1"
                    //SQL : "select codigo_empr into :zona.cod_empr from v_serial_situacion where codigo_producto = :cod_producto and rownum=1"
                    //SQL : "INSERT INTO ABC(ABC_CODIGO, ABC_DESCRIPCION) VALUES ( 94, 'TEST')"
                    //SQL : "update dept_name from departments where dept_no = :dept_no and :Nombre is null"
                    , transactiontype : 'DML'
                    , sourcename : 'default3'
                    //, action : 'resultonly'
                    , BIND : JSON.stringify({dept_no: 'd001' , nombre : null, cod_producto: 201083})
                }
                ,success: function (result) {
                    // DO stuff
                    //console.log(result.DATA);
                    //console.log(result.HEADER);
                    //console.log(result.INFO);
                    console.log(result);
                }
                , error : function(xhr) {
                    var errorDetail = xhr.responseJSON;
                    console.log("Error", xhr.status, 'INTERNAL CODE' , errorDetail.ERROR.CODE, 'MESSAGE', errorDetail.ERROR.MESSAGE);
                    //console.log('a=',a,'b=',b,'c=', c,'d=',d);
                }
            });
        }
    });
</script>

    <style>
        .__testTreeContainer{
            float: left;
            height: 100%;
            position: relative;
            width: 100%;
        }
    </style>

</head>
<body>
<div class="__testTreeContainer"  style="padding:0;margin:0;overflow:auto">
    <header class="__header">Resultado del Arbol</header>
    <div id="testTree">


    </div>
    <footer class="__footer">. </footer>
</div>
</body>

</html>